apiVersion: v1
kind: ConfigMap
metadata:
  name: dynhost-failover-script
  namespace: kube-system
data:
  failover.sh: |
    #!/bin/sh
    set -e

    log() {
      echo "$(date '+%Y-%m-%d %H:%M:%S') $1"
    }

    K8S_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    K8S_API="https://kubernetes.default.svc"

    # Auto-detect node IPs from Kubernetes API, sorted for deterministic priority
    detect_nodes() {
      curl -sk -H "Authorization: Bearer ${K8S_TOKEN}" \
        "${K8S_API}/api/v1/nodes" | \
        awk '/"InternalIP"/{getline; gsub(/[" ]/, ""); sub(/address:/, ""); print}' | \
        sort -t. -k1,1n -k2,2n -k3,3n -k4,4n
    }

    check_health() {
      url=$(echo "$HEALTH_URL_TEMPLATE" | sed "s/__IP__/$1/")
      result=$(curl -sk --max-time 5 "$url" 2>/dev/null) || return 1
      echo "$result" | grep -q "ok"
    }

    resolve_dns() {
      nslookup "$DYNHOST_HOSTNAME" dns.ovh.net 2>/dev/null | \
        awk '/^Address:/ && !/dns\.ovh\.net/ {print $2}' | \
        tail -1
    }

    update_dns() {
      log "UPDATE: $DYNHOST_HOSTNAME $CURRENT_IP -> $1"
      RESULT=$(curl -s --max-time 10 -u "${DYNHOST_USER}:${DYNHOST_PASS}" \
        "https://www.ovh.com/nic/update?system=dyndns&hostname=${DYNHOST_HOSTNAME}&myip=$1")
      log "DynHost response: $RESULT"
    }

    # Detect nodes
    NODE_IPS=$(detect_nodes)
    NODE_COUNT=$(echo "$NODE_IPS" | wc -l)

    if [ "$NODE_COUNT" -eq 0 ] || [ -z "$NODE_IPS" ]; then
      log "CRIT: Could not detect any nodes from Kubernetes API"
      exit 1
    fi

    log "Detected $NODE_COUNT nodes: $(echo $NODE_IPS | tr '\n' ' ')"

    # Resolve current DNS
    CURRENT_IP=$(resolve_dns)
    if [ -z "$CURRENT_IP" ]; then
      log "WARN: Could not resolve $DYNHOST_HOSTNAME"
    fi

    # --- Test rotate mode ---
    ROTATE="${TEST_ROTATE_INTERVAL:-0}"
    if [ "$ROTATE" != "0" ] && [ -n "$ROTATE" ]; then
      EPOCH=$(date +%s)
      INDEX=$(( (EPOCH / ROTATE) % NODE_COUNT ))
      TARGET=$(echo "$NODE_IPS" | sed -n "$((INDEX + 1))p")

      if [ "$CURRENT_IP" != "$TARGET" ]; then
        log "TEST ROTATE: slot=$INDEX target=$TARGET"
        update_dns "$TARGET"
      else
        log "TEST ROTATE: OK slot=$INDEX -> $TARGET"
      fi
      exit 0
    fi

    # --- Normal failover mode ---
    BEST_IP=""
    for ip in $NODE_IPS; do
      if check_health "$ip"; then
        BEST_IP="$ip"
        break
      else
        log "WARN: Node $ip is unhealthy"
      fi
    done

    if [ -z "$BEST_IP" ]; then
      log "CRIT: No healthy node found â€” keeping current DNS ($CURRENT_IP)"
      exit 0
    fi

    if [ "$CURRENT_IP" != "$BEST_IP" ]; then
      update_dns "$BEST_IP"
    else
      log "OK: $DYNHOST_HOSTNAME -> $BEST_IP"
    fi
