---
# =============================================================================
# OVH â€” Reset/destroy cluster
#
# Usage:
#   cd ansible
#   ansible-playbook -i environments/ovh/hosts.yml environments/ovh/destroy.yml
#
# This resets Talos nodes and cleans up local generated files.
# To fully decommission, cancel the VPS in OVH panel.
# =============================================================================
- name: Reset Talos cluster on OVH VPS
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Reset all nodes (wipes etcd, removes Kubernetes state)
      ansible.builtin.command:
        cmd: >-
          talosctl reset
            --talosconfig {{ talos_work_dir }}/talosconfig
            --nodes {{ item.ip }}
            --endpoints {{ item.ip }}
            --graceful=false
            --reboot
      loop: "{{ controlplane_nodes + worker_nodes }}"
      loop_control:
        label: "{{ item.name }}"
      ignore_errors: true

    - name: Clean up local work directory
      ansible.builtin.file:
        path: "{{ talos_work_dir }}"
        state: absent
      when: talos_work_dir != talos_local_dir
