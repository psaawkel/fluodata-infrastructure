---
# =============================================================================
# OVH â€” Full cluster deployment
#
# Usage:
#   cd ansible
#   ansible-playbook -i environments/ovh/hosts.yml environments/ovh/site.yml
#
# Prerequisites:
#   1. VPS ordered and IPs known (update hosts.yml and group_vars/all.yml)
#   2. VPS booted into rescue mode (OVH panel)
#   3. talosctl, kubectl, helm installed locally
#
# Flow:
#   1. talos_install: SSH to rescue mode, dd Talos image to disk, reboot
#   2. talos_bootstrap: Generate secrets+configs, wait for Talos API, apply, bootstrap
#   3. cilium: Install Cilium CNI via Helm
# =============================================================================

# --- Stage 1: Install Talos via rescue mode ---
- name: Install Talos on OVH VPS (rescue mode)
  hosts: rescue_mode
  gather_facts: false
  roles:
    - talos_install

# --- Stage 2+3: Bootstrap Talos cluster and install Cilium ---
- name: Bootstrap Talos cluster and install Cilium
  hosts: localhost
  gather_facts: false
  roles:
    - talos_bootstrap
    - cilium
