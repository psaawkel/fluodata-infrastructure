---
# =============================================================================
# destroy-proxmox.yml â€” Tear down Proxmox cluster VMs
#
# Usage:
#   cd ansible
#   ansible-playbook destroy-proxmox.yml -e env=../environments/proxmox-homelab
# =============================================================================

# --- Load config ---
- name: Load environment config
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Fail if env is not specified
      ansible.builtin.fail:
        msg: "Specify environment: ansible-playbook destroy-proxmox.yml -e env=../environments/proxmox-homelab"
      when: env is not defined

    - name: Resolve env_dir to absolute path
      ansible.builtin.set_fact:
        env_dir: "{{ (playbook_dir ~ '/' ~ env) | realpath }}"

    - name: Load config.yml
      ansible.builtin.include_vars:
        file: "{{ env_dir }}/config.yml"

    - name: Validate platform is Proxmox
      ansible.builtin.fail:
        msg: "This playbook is for Proxmox environments. config.yml has platform='{{ platform | default('undefined') }}'"
      when: platform | default('') != 'proxmox'

    - name: Set computed variables
      ansible.builtin.set_fact:
        env_dir: "{{ env_dir }}"
        controlplane_nodes: "{{ controlplane_nodes }}"
        worker_nodes: "{{ worker_nodes | default([]) }}"
        all_nodes: "{{ controlplane_nodes + (worker_nodes | default([])) }}"
        proxmox_host: "{{ proxmox_host }}"
        proxmox_node: "{{ proxmox_node }}"
        proxmox_api_user: "{{ proxmox_api_user }}"
        proxmox_api_token_id: "{{ proxmox_api_token_id }}"
        proxmox_api_token_secret: "{{ proxmox_api_token_secret }}"

    - name: Add Proxmox host to inventory
      ansible.builtin.add_host:
        name: proxmox
        ansible_host: "{{ proxmox_ssh_host }}"
        ansible_user: "{{ proxmox_ssh_user }}"
        groups: proxmox_hosts

    - name: Show destroy info
      ansible.builtin.debug:
        msg: |
          Env folder:  {{ env_dir }}
          Nodes:       {{ all_nodes | map(attribute='name') | join(', ') }}

# --- Destroy VMs ---
- name: Destroy Talos cluster VMs
  hosts: proxmox_hosts
  gather_facts: false
  tasks:
    - name: Stop all VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: stopped
        force: true
        timeout: 60
      loop: "{{ all_nodes }}"
      loop_control:
        label: "{{ item.name }}"
      delegate_to: localhost
      become: false
      ignore_errors: true

    - name: Destroy all VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: absent
        force: true
        timeout: 120
      loop: "{{ all_nodes }}"
      loop_control:
        label: "{{ item.name }}"
      delegate_to: localhost
      become: false
      ignore_errors: true
