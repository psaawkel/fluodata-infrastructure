---
# tasks/validate-proxmox.yml â€” Validate Proxmox config and set computed variables
#
# Prerequisite: tasks/load-config.yml must run first
#
# Node `host` field: IPv4 address for the VM (used for DHCP reservation + Talos static IP).
# The `ip` field is auto-derived from `host` for downstream compatibility.
#
# Node `role` field: cp | worker | cpworker
#   - cp: control plane only (NoSchedule taint)
#   - worker: worker only
#   - cpworker: combined control plane + worker (schedules workloads)

- name: Validate platform is proxmox
  ansible.builtin.fail:
    msg: "This playbook is for Proxmox environments. config.yml has platform='{{ platform | default('undefined') }}'"
  when: platform | default('') != 'proxmox'

- name: Validate required Proxmox fields
  ansible.builtin.fail:
    msg: "Missing required field: {{ item }}"
  loop:
    - proxmox_host
    - proxmox_node
    - proxmox_api_user
    - proxmox_api_token_id
    - proxmox_api_token_secret
    - proxmox_ssh_host
    - proxmox_ssh_user
    - cluster_name
    - talos_version
    - talos_schematic_id
    - nodes
    - vm_gateway
  when: lookup('vars', item, default='__MISSING__') == '__MISSING__'

- name: Validate node roles
  ansible.builtin.fail:
    msg: "Node {{ item.name }}: invalid role '{{ item.role | default('undefined') }}'. Must be cp, worker, or cpworker."
  loop: "{{ nodes }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.role | default('') not in ['cp', 'worker', 'cpworker']

- name: Validate at least one control plane node
  ansible.builtin.fail:
    msg: "No control plane nodes defined. At least one node must have role 'cp' or 'cpworker'."
  when: nodes | selectattr('role', 'in', ['cp', 'cpworker']) | list | length == 0

# Enrich nodes: derive ip from host (for Proxmox, host is always an IPv4)
- name: Build enriched nodes list
  ansible.builtin.set_fact:
    _enriched_nodes: "{{ _enriched_nodes | default([]) + [item | combine({'ip': item.ip | default(item.host)})] }}"
  loop: "{{ nodes }}"
  loop_control:
    label: "{{ item.name }}"

- name: Set computed variables
  ansible.builtin.set_fact:
    env_dir: "{{ env_dir }}"
    cluster_name: "{{ cluster_name }}"
    cluster_vip: "{{ cluster_vip | default(omit) }}"
    talos_version: "{{ talos_version }}"
    talos_schematic_id: "{{ talos_schematic_id }}"
    talos_iso_url: "https://factory.talos.dev/image/{{ talos_schematic_id }}/{{ talos_version }}/nocloud-amd64.iso"
    talos_iso_filename: "talos-{{ talos_version }}.iso"
    talos_iso_storage: "{{ talos_iso_storage | default('local') }}"
    talos_install_image: "factory.talos.dev/installer/{{ talos_schematic_id }}:{{ talos_version }}"
    talos_install_disk: "{{ talos_install_disk | default('/dev/sda') }}"
    all_nodes: "{{ _enriched_nodes }}"
    controlplane_nodes: "{{ _enriched_nodes | selectattr('role', 'in', ['cp', 'cpworker']) | list }}"
    worker_nodes: "{{ _enriched_nodes | selectattr('role', 'equalto', 'worker') | list }}"
    cluster_endpoint: "{{ 'https://' ~ (cluster_vip | default((_enriched_nodes | selectattr('role', 'in', ['cp', 'cpworker']) | first).ip)) ~ ':6443' }}"
    vm_bridge: "{{ vm_bridge | default('vmbr1') }}"
    vm_gateway: "{{ vm_gateway }}"
    vm_subnet_mask: "{{ vm_subnet_mask | default(24) }}"
    vm_nameservers: "{{ vm_nameservers | default(['1.1.1.1']) }}"
    vm_storage: "{{ vm_storage | default('local-lvm') }}"
    cilium_version: "{{ cilium_version | default('1.17.3') }}"
    etcd_advertised_subnets:
      - "{{ vm_gateway }}/{{ vm_subnet_mask | default(24) }}"
    dhcp_range_start: "{{ dhcp_range_start | default('10.10.0.100') }}"
    dhcp_range_end: "{{ dhcp_range_end | default('10.10.0.200') }}"
    dhcp_lease_time: "{{ dhcp_lease_time | default('12h') }}"
    proxmox_host: "{{ proxmox_host }}"
    proxmox_node: "{{ proxmox_node }}"
    proxmox_api_user: "{{ proxmox_api_user }}"
    proxmox_api_token_id: "{{ proxmox_api_token_id }}"
    proxmox_api_token_secret: "{{ proxmox_api_token_secret }}"

- name: Add Proxmox host to inventory
  ansible.builtin.add_host:
    name: proxmox
    ansible_host: "{{ proxmox_ssh_host }}"
    ansible_user: "{{ proxmox_ssh_user }}"
    groups: proxmox_hosts
    # Pass vars needed by Play 2 roles (set_fact on localhost doesn't propagate)
    # Used by: proxmox_dnsmasq, proxmox_vms, talos_bootstrap_proxmox, proxmox_post_install, cilium
    env_dir: "{{ env_dir }}"
    cluster_name: "{{ cluster_name }}"
    cluster_vip: "{{ cluster_vip | default(omit) }}"
    cluster_endpoint: "{{ cluster_endpoint }}"
    talos_version: "{{ talos_version }}"
    talos_iso_url: "{{ talos_iso_url }}"
    talos_iso_filename: "{{ talos_iso_filename }}"
    talos_iso_storage: "{{ talos_iso_storage }}"
    controlplane_nodes: "{{ controlplane_nodes }}"
    worker_nodes: "{{ worker_nodes }}"
    all_nodes: "{{ all_nodes }}"
    vm_bridge: "{{ vm_bridge }}"
    vm_gateway: "{{ vm_gateway }}"
    vm_subnet_mask: "{{ vm_subnet_mask }}"
    vm_nameservers: "{{ vm_nameservers }}"
    vm_storage: "{{ vm_storage }}"
    cilium_version: "{{ cilium_version }}"
    dhcp_range_start: "{{ dhcp_range_start }}"
    dhcp_range_end: "{{ dhcp_range_end }}"
    dhcp_lease_time: "{{ dhcp_lease_time }}"
    proxmox_host: "{{ proxmox_host }}"
    proxmox_node: "{{ proxmox_node }}"
    proxmox_api_user: "{{ proxmox_api_user }}"
    proxmox_api_token_id: "{{ proxmox_api_token_id }}"
    proxmox_api_token_secret: "{{ proxmox_api_token_secret }}"

- name: Show deployment info
  ansible.builtin.debug:
    msg: |
      Cluster:     {{ cluster_name }}
      Endpoint:    {{ cluster_endpoint }}
      Env folder:  {{ env_dir }}
      CP nodes:    {{ controlplane_nodes | map(attribute='name') | join(', ') }}
      Workers:     {{ worker_nodes | map(attribute='name') | join(', ') | default('(none)') }}
