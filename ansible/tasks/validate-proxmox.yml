---
# tasks/validate-proxmox.yml â€” Validate Proxmox config and set computed variables
#
# Prerequisite: tasks/load-config.yml must run first
#
# Node `host` field: IPv4 address for the VM (used for DHCP reservation + Talos static IP).
# The `ip` field is auto-derived from `host` for downstream compatibility.

- name: Validate platform is proxmox
  ansible.builtin.fail:
    msg: "This playbook is for Proxmox environments. config.yml has platform='{{ platform | default('undefined') }}'"
  when: platform | default('') != 'proxmox'

- name: Validate required Proxmox fields
  ansible.builtin.fail:
    msg: "Missing required field: {{ item }}"
  loop:
    - proxmox_host
    - proxmox_node
    - proxmox_api_user
    - proxmox_api_token_id
    - proxmox_api_token_secret
    - proxmox_ssh_host
    - proxmox_ssh_user
    - cluster_name
    - talos_version
    - talos_schematic_id
    - controlplane_nodes
    - vm_gateway
  when: lookup('vars', item, default='__MISSING__') == '__MISSING__'

# Enrich nodes: derive ip from host (for Proxmox, host is always an IPv4)
- name: Build enriched controlplane nodes
  ansible.builtin.set_fact:
    _enriched_cp_nodes: "{{ _enriched_cp_nodes | default([]) + [item | combine({'ip': item.ip | default(item.host)})] }}"
  loop: "{{ controlplane_nodes }}"
  loop_control:
    label: "{{ item.name }}"

- name: Build enriched worker nodes
  ansible.builtin.set_fact:
    _enriched_worker_nodes: "{{ _enriched_worker_nodes | default([]) + [item | combine({'ip': item.ip | default(item.host)})] }}"
  loop: "{{ worker_nodes | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when: (worker_nodes | default([])) | length > 0

- name: Set computed variables
  ansible.builtin.set_fact:
    env_dir: "{{ env_dir }}"
    cluster_name: "{{ cluster_name }}"
    cluster_vip: "{{ cluster_vip | default(omit) }}"
    cluster_endpoint: "{{ 'https://' ~ (cluster_vip | default(_enriched_cp_nodes[0].ip)) ~ ':6443' }}"
    talos_version: "{{ talos_version }}"
    talos_schematic_id: "{{ talos_schematic_id }}"
    talos_iso_url: "https://factory.talos.dev/image/{{ talos_schematic_id }}/{{ talos_version }}/nocloud-amd64.iso"
    talos_iso_filename: "talos-{{ talos_version }}.iso"
    talos_iso_storage: "{{ talos_iso_storage | default('local') }}"
    talos_install_image: "factory.talos.dev/installer/{{ talos_schematic_id }}:{{ talos_version }}"
    talos_install_disk: "{{ talos_install_disk | default('/dev/sda') }}"
    controlplane_nodes: "{{ _enriched_cp_nodes }}"
    worker_nodes: "{{ _enriched_worker_nodes | default([]) }}"
    all_nodes: "{{ _enriched_cp_nodes + (_enriched_worker_nodes | default([])) }}"
    vm_bridge: "{{ vm_bridge | default('vmbr1') }}"
    vm_gateway: "{{ vm_gateway }}"
    vm_subnet_mask: "{{ vm_subnet_mask | default(24) }}"
    vm_nameservers: "{{ vm_nameservers | default(['1.1.1.1']) }}"
    vm_storage: "{{ vm_storage | default('local-lvm') }}"
    cilium_version: "{{ cilium_version | default('1.17.3') }}"
    etcd_advertised_subnets:
      - "{{ vm_gateway }}/{{ vm_subnet_mask | default(24) }}"
    dhcp_range_start: "{{ dhcp_range_start | default('10.10.0.100') }}"
    dhcp_range_end: "{{ dhcp_range_end | default('10.10.0.200') }}"
    dhcp_lease_time: "{{ dhcp_lease_time | default('12h') }}"
    proxmox_host: "{{ proxmox_host }}"
    proxmox_node: "{{ proxmox_node }}"
    proxmox_api_user: "{{ proxmox_api_user }}"
    proxmox_api_token_id: "{{ proxmox_api_token_id }}"
    proxmox_api_token_secret: "{{ proxmox_api_token_secret }}"

- name: Add Proxmox host to inventory
  ansible.builtin.add_host:
    name: proxmox
    ansible_host: "{{ proxmox_ssh_host }}"
    ansible_user: "{{ proxmox_ssh_user }}"
    groups: proxmox_hosts
    # Pass vars needed by Play 2 roles (set_fact on localhost doesn't propagate)
    # Used by: proxmox_dnsmasq, proxmox_vms, talos_bootstrap_proxmox, proxmox_post_install, cilium
    env_dir: "{{ env_dir }}"
    cluster_name: "{{ cluster_name }}"
    cluster_vip: "{{ cluster_vip | default(omit) }}"
    cluster_endpoint: "{{ cluster_endpoint }}"
    talos_version: "{{ talos_version }}"
    talos_iso_url: "{{ talos_iso_url }}"
    talos_iso_filename: "{{ talos_iso_filename }}"
    talos_iso_storage: "{{ talos_iso_storage }}"
    controlplane_nodes: "{{ controlplane_nodes }}"
    worker_nodes: "{{ worker_nodes }}"
    all_nodes: "{{ all_nodes }}"
    vm_bridge: "{{ vm_bridge }}"
    vm_gateway: "{{ vm_gateway }}"
    vm_subnet_mask: "{{ vm_subnet_mask }}"
    vm_nameservers: "{{ vm_nameservers }}"
    vm_storage: "{{ vm_storage }}"
    cilium_version: "{{ cilium_version }}"
    dhcp_range_start: "{{ dhcp_range_start }}"
    dhcp_range_end: "{{ dhcp_range_end }}"
    dhcp_lease_time: "{{ dhcp_lease_time }}"
    proxmox_host: "{{ proxmox_host }}"
    proxmox_node: "{{ proxmox_node }}"
    proxmox_api_user: "{{ proxmox_api_user }}"
    proxmox_api_token_id: "{{ proxmox_api_token_id }}"
    proxmox_api_token_secret: "{{ proxmox_api_token_secret }}"

- name: Show deployment info
  ansible.builtin.debug:
    msg: |
      Cluster:     {{ cluster_name }}
      Endpoint:    {{ cluster_endpoint }}
      Env folder:  {{ env_dir }}
      CP nodes:    {{ controlplane_nodes | map(attribute='name') | join(', ') }}
      Workers:     {{ (worker_nodes | default([])) | map(attribute='name') | join(', ') | default('(none)') }}
