---
# =============================================================================
# deploy-proxmox.yml â€” Deploy Talos cluster on Proxmox
#
# Usage:
#   cd ansible
#   ansible-playbook deploy-proxmox.yml -e env=../environments/proxmox-homelab
# =============================================================================

# --- Load config and validate ---
- name: Load environment config
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Fail if env is not specified
      ansible.builtin.fail:
        msg: "Specify environment: ansible-playbook deploy-proxmox.yml -e env=../environments/proxmox-homelab"
      when: env is not defined

    - name: Resolve env_dir to absolute path
      ansible.builtin.set_fact:
        env_dir: "{{ (playbook_dir ~ '/' ~ env) | realpath }}"

    - name: Check config.yml exists
      ansible.builtin.stat:
        path: "{{ env_dir }}/config.yml"
      register: config_stat

    - name: Fail if config.yml not found
      ansible.builtin.fail:
        msg: "config.yml not found in {{ env_dir }}"
      when: not config_stat.stat.exists

    - name: Load config.yml
      ansible.builtin.include_vars:
        file: "{{ env_dir }}/config.yml"

    - name: Validate platform is Proxmox
      ansible.builtin.fail:
        msg: "This playbook is for Proxmox environments. config.yml has platform='{{ platform | default('undefined') }}'"
      when: platform | default('') != 'proxmox'

    - name: Validate required fields
      ansible.builtin.fail:
        msg: "Missing required field: {{ item }}"
      loop:
        - proxmox_host
        - proxmox_node
        - proxmox_api_user
        - proxmox_api_token_id
        - proxmox_api_token_secret
        - proxmox_ssh_host
        - proxmox_ssh_user
        - cluster_name
        - talos_version
        - talos_schematic_id
        - controlplane_nodes
        - vm_gateway
      when: lookup('vars', item, default='__MISSING__') == '__MISSING__'

    - name: Set computed variables
      ansible.builtin.set_fact:
        env_dir: "{{ env_dir }}"
        cluster_name: "{{ cluster_name }}"
        cluster_vip: "{{ cluster_vip | default(omit) }}"
        cluster_endpoint: "{{ 'https://' ~ (cluster_vip | default(controlplane_nodes[0].ip)) ~ ':6443' }}"
        talos_version: "{{ talos_version }}"
        talos_schematic_id: "{{ talos_schematic_id }}"
        talos_iso_url: "https://factory.talos.dev/image/{{ talos_schematic_id }}/{{ talos_version }}/nocloud-amd64.iso"
        talos_iso_filename: "talos-{{ talos_version }}.iso"
        talos_iso_storage: "{{ talos_iso_storage | default('local') }}"
        talos_install_image: "factory.talos.dev/installer/{{ talos_schematic_id }}:{{ talos_version }}"
        talos_install_disk: "{{ talos_install_disk | default('/dev/sda') }}"
        controlplane_nodes: "{{ controlplane_nodes }}"
        worker_nodes: "{{ worker_nodes | default([]) }}"
        all_nodes: "{{ controlplane_nodes + (worker_nodes | default([])) }}"
        vm_bridge: "{{ vm_bridge | default('vmbr1') }}"
        vm_gateway: "{{ vm_gateway }}"
        vm_subnet_mask: "{{ vm_subnet_mask | default(24) }}"
        vm_nameservers: "{{ vm_nameservers | default(['1.1.1.1']) }}"
        vm_storage: "{{ vm_storage | default('local-lvm') }}"
        cilium_version: "{{ cilium_version | default('1.17.3') }}"
        proxmox_host: "{{ proxmox_host }}"
        proxmox_node: "{{ proxmox_node }}"
        proxmox_api_user: "{{ proxmox_api_user }}"
        proxmox_api_token_id: "{{ proxmox_api_token_id }}"
        proxmox_api_token_secret: "{{ proxmox_api_token_secret }}"

    - name: Add Proxmox host to inventory
      ansible.builtin.add_host:
        name: proxmox
        ansible_host: "{{ proxmox_ssh_host }}"
        ansible_user: "{{ proxmox_ssh_user }}"
        groups: proxmox_hosts

    - name: Show deployment info
      ansible.builtin.debug:
        msg: |
          Cluster:     {{ cluster_name }}
          Endpoint:    {{ cluster_endpoint }}
          Env folder:  {{ env_dir }}
          CP nodes:    {{ controlplane_nodes | map(attribute='name') | join(', ') }}
          Workers:     {{ (worker_nodes | default([])) | map(attribute='name') | join(', ') | default('(none)') }}

# --- Create VMs ---
- name: Create and start VMs
  hosts: proxmox_hosts
  gather_facts: false
  roles:
    - proxmox_vms

# --- Bootstrap Talos ---
- name: Bootstrap Talos cluster
  hosts: proxmox_hosts
  gather_facts: false
  roles:
    - talos_bootstrap

# --- Post-install (boot order fix) ---
- name: Post-install fixes
  hosts: proxmox_hosts
  gather_facts: false
  roles:
    - proxmox_post_install

# --- Install Cilium ---
- name: Install Cilium
  hosts: proxmox_hosts
  gather_facts: false
  roles:
    - cilium
