---
# =============================================================================
# vps-deploy-rescue.yml — Write Talos image to VPS disk + generate configs
#
# Usage:
#   cd ansible
#   ansible-playbook vps-deploy-rescue.yml -e env=../environments/vps-ovh-test
#
# Prerequisites:
#   1. VPS booted into rescue mode (provider dashboard)
#   2. Rescue mode SSH credentials in config.yml
#
# After this playbook completes:
#   1. Switch VPS boot mode back to local/normal (provider dashboard)
#   2. Reboot the VPS (provider dashboard)
#   3. Wait ~60s for Talos to boot in maintenance mode
#   4. Run: ansible-playbook vps-deploy.yml -e env=../environments/vps-ovh-test
# =============================================================================

# --- Load config, validate, generate Talos configs ---
- name: Load config and generate Talos configs
  hosts: localhost
  gather_facts: false
  pre_tasks:
    - ansible.builtin.include_tasks: tasks/load-config.yml
    - ansible.builtin.include_tasks: tasks/validate-vps.yml
  roles:
    - talos_generate

# --- Install Talos via rescue mode ---
- name: Install Talos on VPS nodes (rescue mode)
  hosts: rescue_mode
  gather_facts: false
  roles:
    - talos_install

# --- Done — remind user of next steps ---
- name: Post-install instructions
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Show next steps
      ansible.builtin.debug:
        msg: |
          ====================================================================
          Talos image written to disk. Configs generated in {{ env_dir }}.

          NEXT STEPS:
            1. Switch VPS boot mode from rescue → local/normal
               (OVH: Dashboard → VPS → Boot → Normal boot → Reboot)
            2. Wait ~60 seconds for Talos to boot in maintenance mode
            3. Run the deploy playbook:
               ansible-playbook vps-deploy.yml -e env={{ env }}
          ====================================================================
