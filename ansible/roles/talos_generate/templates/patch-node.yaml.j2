# Per-node patch: static IP, routes, nameservers, VIP (CP only), install image
# Network settings loaded from node-facts-<name>.yml (auto-detected from rescue mode)
# Config.yml node values override detected values
machine:
  network:
    interfaces:
      - deviceSelector:
          physical: true
        addresses:
          - {{ item.ip }}/{{ _node_subnet_mask }}
{% if item.name in controlplane_nodes | map(attribute='name') | list and cluster_vip is defined %}
        vip:
          ip: {{ cluster_vip }}
{% endif %}
        routes:
{% if _node_subnet_mask | int == 32 %}
          # /32 point-to-point: direct route to gateway via interface, then default
          - network: {{ _node_gateway }}/32
{% endif %}
          - network: 0.0.0.0/0
            gateway: {{ _node_gateway }}
    nameservers:
{% for ns in _node_nameservers %}
      - {{ ns }}
{% endfor %}
  install:
    disk: {{ _node_install_disk }}
    image: {{ talos_install_image }}
