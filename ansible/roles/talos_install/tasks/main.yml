---
# =============================================================================
# Role: talos_install — Write Talos disk image to VPS nodes
#
# Assumes VPS nodes are booted into rescue mode (Debian-based).
# Downloads Talos metal image and writes it directly to disk with dd.
# After reboot, VPS boots Talos from disk in maintenance mode.
#
# Install disk is auto-detected by vps_detect role (saved in node facts).
# Config.yml can override with per-node install_disk.
#
# This role targets the VPS nodes themselves (via rescue mode SSH).
# =============================================================================

- name: Load node facts
  ansible.builtin.include_vars:
    file: "{{ hostvars[inventory_hostname]._env_dir }}/node-facts-{{ inventory_hostname }}.yml"
    name: _node_facts
  delegate_to: localhost

- name: Resolve install disk (config override > detected)
  ansible.builtin.set_fact:
    _install_disk: "{{ hostvars[inventory_hostname]._node_config.install_disk | default(_node_facts.install_disk) }}"

- name: Show install target
  ansible.builtin.debug:
    msg: "Installing Talos to {{ _install_disk }} on {{ inventory_hostname }} ({{ hostvars[inventory_hostname]._node_config.host }})"

- name: Download Talos metal image
  ansible.builtin.get_url:
    url: "{{ talos_metal_image_url }}"
    dest: /tmp/talos-metal.raw.xz
    mode: "0644"
    timeout: 300

- name: Write Talos image to disk
  ansible.builtin.shell:
    cmd: xz -d --stdout /tmp/talos-metal.raw.xz | dd of={{ _install_disk }} bs=4M status=progress conv=fsync

- name: Clean up downloaded image
  ansible.builtin.file:
    path: /tmp/talos-metal.raw.xz
    state: absent

# NOTE: This role does NOT reboot. The VPS must be rebooted externally:
#   - OVH: Switch netboot from rescue → local in dashboard, then reboot
#   - Other providers: reboot via provider dashboard or API
# After reboot, Talos boots in maintenance mode (port 50000).
# Then run vps-deploy.yml for bootstrap + Cilium.
