---
# =============================================================================
# Role: kubelet_cert_approver â€” Deploy kubelet-serving-cert-approver
#
# Auto-approves kubelet serving certificate CSRs (kubernetes.io/kubelet-serving
# signer). Without this, kubelet port 10250 gets TLS errors because the CSRs
# for serving certs stay Pending indefinitely.
#
# Requires kubeconfig_path to be set by the preceding bootstrap role.
# =============================================================================

- name: Apply kubelet-serving-cert-approver manifest
  ansible.builtin.command:
    cmd: kubectl apply -f {{ manifest_path }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  vars:
    manifest_path: "{{ role_path }}/files/kubelet-serving-cert-approver.yaml"
  register: apply_result
  changed_when: "'created' in apply_result.stdout or 'configured' in apply_result.stdout"

- name: Wait for kubelet-serving-cert-approver deployment to be ready
  ansible.builtin.command:
    cmd: >-
      kubectl rollout status deployment/kubelet-serving-cert-approver
        --namespace kubelet-serving-cert-approver
        --timeout=120s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: rollout_result
  changed_when: false
