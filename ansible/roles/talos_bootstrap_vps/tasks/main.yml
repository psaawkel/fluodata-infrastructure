---
# =============================================================================
# Role: talos_bootstrap_vps — Apply configs, bootstrap, kubeconfig
#
# Runs on localhost. VPS nodes have public IPs, so talosctl reaches them directly.
# Configs were generated by talos_generate → env_dir.
# All commands run locally, all files stay in env_dir.
#
# Required variables:
#   - env_dir, cluster_name, cluster_endpoint, talos_version
#   - controlplane_nodes, worker_nodes, all_nodes
#   (each node has both `host` for connections and `ip` for Talos config)
# =============================================================================

# =============================================================================
# Wait for Talos API, detect mode, apply configs
# =============================================================================
- name: Wait for Talos API on all nodes (port 50000)
  ansible.builtin.wait_for:
    host: "{{ item.host }}"
    port: 50000
    timeout: 300
    delay: 10
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"

# Check if node is already configured (authenticated talosctl works)
- name: Check if first CP node is already configured
  ansible.builtin.command:
    cmd: >-
      talosctl version
        --talosconfig {{ env_dir }}/talosconfig
        --nodes {{ controlplane_nodes[0].host }}
        --endpoints {{ controlplane_nodes[0].host }}
  register: _node_configured_check
  failed_when: false
  changed_when: false

- name: Set node configuration state
  ansible.builtin.set_fact:
    _nodes_in_maintenance: "{{ _node_configured_check.rc != 0 }}"

# --- Maintenance mode path (first-time apply with --insecure) ---
- name: Apply config to control plane nodes (maintenance mode)
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --insecure
        --nodes {{ item.host }}
        --endpoints {{ item.host }}
        --config-patch @{{ env_dir }}/patch-{{ item.name }}.yaml
        --file {{ env_dir }}/controlplane.yaml
  loop: "{{ controlplane_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  when: _nodes_in_maintenance

- name: Apply config to worker nodes (maintenance mode)
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --insecure
        --nodes {{ item.host }}
        --endpoints {{ item.host }}
        --config-patch @{{ env_dir }}/patch-{{ item.name }}.yaml
        --file {{ env_dir }}/worker.yaml
  loop: "{{ worker_nodes | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when: _nodes_in_maintenance and (worker_nodes | default([])) | length > 0

# --- Already-configured path (re-apply with auth) ---
- name: Apply config to control plane nodes (authenticated)
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --talosconfig {{ env_dir }}/talosconfig
        --nodes {{ item.host }}
        --endpoints {{ item.host }}
        --config-patch @{{ env_dir }}/patch-{{ item.name }}.yaml
        --file {{ env_dir }}/controlplane.yaml
  loop: "{{ controlplane_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  when: not _nodes_in_maintenance

- name: Apply config to worker nodes (authenticated)
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --talosconfig {{ env_dir }}/talosconfig
        --nodes {{ item.host }}
        --endpoints {{ item.host }}
        --config-patch @{{ env_dir }}/patch-{{ item.name }}.yaml
        --file {{ env_dir }}/worker.yaml
  loop: "{{ worker_nodes | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  when: not _nodes_in_maintenance and (worker_nodes | default([])) | length > 0

# =============================================================================
# Wait for Talos API (after potential reboot from maintenance), bootstrap
# =============================================================================
- name: Wait for nodes to boot and Talos API to be ready
  ansible.builtin.wait_for:
    host: "{{ item.host }}"
    port: 50000
    timeout: 300
    delay: "{{ 30 if _nodes_in_maintenance else 5 }}"
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"

- name: Bootstrap etcd on first control plane
  ansible.builtin.command:
    cmd: >-
      talosctl bootstrap
        --talosconfig {{ env_dir }}/talosconfig
        --nodes {{ controlplane_nodes[0].host }}
        --endpoints {{ controlplane_nodes[0].host }}
  register: bootstrap_result
  failed_when:
    - bootstrap_result.rc != 0
    - "'AlreadyExists' not in bootstrap_result.stderr"

- name: Wait for Kubernetes API (port 6443)
  ansible.builtin.wait_for:
    host: "{{ cluster_vip | default(controlplane_nodes[0].host) }}"
    port: 6443
    timeout: 300
    delay: 15

- name: Generate kubeconfig
  ansible.builtin.command:
    cmd: >-
      talosctl kubeconfig {{ env_dir }}/kubeconfig
        --talosconfig {{ env_dir }}/talosconfig
        --nodes {{ controlplane_nodes[0].host }}
        --endpoints {{ cluster_vip | default(controlplane_nodes[0].host) }}
        --force

# Set kubeconfig_path for cilium role (runs next on same host)
- name: Set kubeconfig path for subsequent roles
  ansible.builtin.set_fact:
    kubeconfig_path: "{{ env_dir }}/kubeconfig"
