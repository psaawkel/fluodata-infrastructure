---
# =============================================================================
# Role: talos_bootstrap — Generate secrets, configs, apply, bootstrap, kubeconfig
#
# Platform-agnostic. Works for both Proxmox and OVH.
#
# talosctl/kubectl/helm commands run on {{ talosctl_host }}:
#   - Proxmox: the Proxmox host (VMs on internal vmbr1, unreachable from laptop)
#   - OVH: localhost (VPS nodes have public/vRack IPs, reachable directly)
#
# Required variables (set in environment group_vars):
#   - cluster_name, cluster_endpoint, cluster_vip
#   - talos_version, talos_install_image
#   - controlplane_nodes, worker_nodes, all_nodes
#   - talos_work_dir       (where talosctl runs: /tmp/talos-deploy or local path)
#   - talos_local_dir      (local dir for secrets/kubeconfig persistence)
#   - talosctl_delegate_to (undefined=run on inventory host, "localhost"=run locally)
#   - vm_gateway, vm_subnet_mask, vm_nameservers (network config for patches)
# =============================================================================

# --- Create work directory ---
- name: Create work directory
  ansible.builtin.file:
    path: "{{ talos_work_dir }}"
    state: directory
    mode: "0700"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# --- Create local talos directory ---
- name: Create local talos directory
  ansible.builtin.file:
    path: "{{ talos_local_dir }}"
    state: directory
    mode: "0700"
  delegate_to: localhost
  become: false

# =============================================================================
# Secrets generation (idempotent — generated once, reused across deploys)
# =============================================================================
- name: Check if secrets exist locally
  ansible.builtin.stat:
    path: "{{ talos_local_dir }}/secrets.yaml"
  register: secrets_local_stat
  delegate_to: localhost
  become: false

- name: Check if secrets exist in work directory
  ansible.builtin.stat:
    path: "{{ talos_work_dir }}/secrets.yaml"
  register: secrets_remote_stat
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate Talos secrets
  ansible.builtin.command:
    cmd: >-
      talosctl gen secrets
        --output-file {{ talos_work_dir }}/secrets.yaml
        --talos-version {{ talos_version }}
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false
  when: not secrets_local_stat.stat.exists and not secrets_remote_stat.stat.exists

- name: Fetch secrets to local (from newly generated or pre-existing remote)
  ansible.builtin.fetch:
    src: "{{ talos_work_dir }}/secrets.yaml"
    dest: "{{ talos_local_dir }}/secrets.yaml"
    flat: true
  when:
    - not secrets_local_stat.stat.exists
    - talosctl_delegate_to is not defined
  # Only fetch when running on remote host; if localhost, work_dir IS local

- name: Copy work dir secrets to local (localhost mode)
  ansible.builtin.copy:
    src: "{{ talos_work_dir }}/secrets.yaml"
    dest: "{{ talos_local_dir }}/secrets.yaml"
    mode: "0600"
    remote_src: true
  delegate_to: localhost
  become: false
  when:
    - not secrets_local_stat.stat.exists
    - talosctl_delegate_to is defined and talosctl_delegate_to == "localhost"
    - talos_work_dir != talos_local_dir

- name: Copy secrets to work directory (if already existed locally)
  ansible.builtin.copy:
    src: "{{ talos_local_dir }}/secrets.yaml"
    dest: "{{ talos_work_dir }}/secrets.yaml"
    mode: "0600"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false
  when: secrets_local_stat.stat.exists

# =============================================================================
# Generate config patches from templates
# =============================================================================
- name: Generate control plane common patch
  ansible.builtin.template:
    src: patch-cp-common.yaml.j2
    dest: "{{ talos_work_dir }}/patch-cp-common.yaml"
    mode: "0600"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate worker common patch
  ansible.builtin.template:
    src: patch-worker-common.yaml.j2
    dest: "{{ talos_work_dir }}/patch-worker-common.yaml"
    mode: "0600"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate per-node patches
  ansible.builtin.template:
    src: patch-node.yaml.j2
    dest: "{{ talos_work_dir }}/patch-{{ item.name }}.yaml"
    mode: "0600"
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# =============================================================================
# Generate Talos configs from secrets + patches
# =============================================================================
- name: Generate control plane config
  ansible.builtin.command:
    cmd: >-
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
        --with-secrets {{ talos_work_dir }}/secrets.yaml
        --config-patch @{{ talos_work_dir }}/patch-cp-common.yaml
        --output {{ talos_work_dir }}/controlplane.yaml
        --output-types controlplane
        --talos-version {{ talos_version }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate worker config
  ansible.builtin.command:
    cmd: >-
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
        --with-secrets {{ talos_work_dir }}/secrets.yaml
        --config-patch @{{ talos_work_dir }}/patch-worker-common.yaml
        --output {{ talos_work_dir }}/worker.yaml
        --output-types worker
        --talos-version {{ talos_version }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate talosconfig
  ansible.builtin.command:
    cmd: >-
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
        --with-secrets {{ talos_work_dir }}/secrets.yaml
        --output {{ talos_work_dir }}/talosconfig
        --output-types talosconfig
        --talos-version {{ talos_version }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# Fix empty endpoints in generated talosconfig
- name: Set talosconfig endpoint
  ansible.builtin.command:
    cmd: >-
      talosctl --talosconfig {{ talos_work_dir }}/talosconfig
        config endpoint {{ cluster_vip | default(controlplane_nodes[0].ip) }}
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Set talosconfig default nodes
  ansible.builtin.command:
    cmd: >-
      talosctl --talosconfig {{ talos_work_dir }}/talosconfig
        config nodes {{ controlplane_nodes | map(attribute='ip') | join(' ') }}
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# =============================================================================
# Wait for Talos maintenance mode, apply configs
# =============================================================================
- name: Wait for Talos API on all nodes (port 50000)
  ansible.builtin.wait_for:
    host: "{{ item.ip }}"
    port: 50000
    timeout: 300
    delay: 10
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Apply config to control plane nodes
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --insecure
        --nodes {{ item.ip }}
        --endpoints {{ item.ip }}
        --config-patch @{{ talos_work_dir }}/patch-{{ item.name }}.yaml
        --file {{ talos_work_dir }}/controlplane.yaml
  loop: "{{ controlplane_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Apply config to worker nodes
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --insecure
        --nodes {{ item.ip }}
        --endpoints {{ item.ip }}
        --config-patch @{{ talos_work_dir }}/patch-{{ item.name }}.yaml
        --file {{ talos_work_dir }}/worker.yaml
  loop: "{{ worker_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# =============================================================================
# Wait for reboot, bootstrap, kubeconfig
# =============================================================================
- name: Wait for nodes to reboot and Talos API to come back
  ansible.builtin.wait_for:
    host: "{{ item.ip }}"
    port: 50000
    timeout: 300
    delay: 30
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Bootstrap etcd on first control plane
  ansible.builtin.command:
    cmd: >-
      talosctl bootstrap
        --talosconfig {{ talos_work_dir }}/talosconfig
        --nodes {{ controlplane_nodes[0].ip }}
        --endpoints {{ controlplane_nodes[0].ip }}
  register: bootstrap_result
  failed_when:
    - bootstrap_result.rc != 0
    - "'AlreadyExists' not in bootstrap_result.stderr"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Wait for Kubernetes API (port 6443)
  ansible.builtin.wait_for:
    host: "{{ cluster_vip | default(controlplane_nodes[0].ip) }}"
    port: 6443
    timeout: 300
    delay: 15
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate kubeconfig
  ansible.builtin.command:
    cmd: >-
      talosctl kubeconfig {{ talos_work_dir }}/kubeconfig
        --talosconfig {{ talos_work_dir }}/talosconfig
        --nodes {{ controlplane_nodes[0].ip }}
        --endpoints {{ cluster_vip | default(controlplane_nodes[0].ip) }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# --- Fetch generated files to local ---
- name: Fetch kubeconfig to local
  ansible.builtin.fetch:
    src: "{{ talos_work_dir }}/kubeconfig"
    dest: "{{ talos_local_dir }}/kubeconfig"
    flat: true
  when: talosctl_delegate_to is not defined

- name: Fetch talosconfig to local
  ansible.builtin.fetch:
    src: "{{ talos_work_dir }}/talosconfig"
    dest: "{{ talos_local_dir }}/talosconfig"
    flat: true
  when: talosctl_delegate_to is not defined

- name: Copy kubeconfig to local (localhost mode)
  ansible.builtin.copy:
    src: "{{ talos_work_dir }}/kubeconfig"
    dest: "{{ talos_local_dir }}/kubeconfig"
    mode: "0600"
    remote_src: true
  delegate_to: localhost
  become: false
  when:
    - talosctl_delegate_to is defined and talosctl_delegate_to == "localhost"
    - talos_work_dir != talos_local_dir

- name: Copy talosconfig to local (localhost mode)
  ansible.builtin.copy:
    src: "{{ talos_work_dir }}/talosconfig"
    dest: "{{ talos_local_dir }}/talosconfig"
    mode: "0600"
    remote_src: true
  delegate_to: localhost
  become: false
  when:
    - talosctl_delegate_to is defined and talosctl_delegate_to == "localhost"
    - talos_work_dir != talos_local_dir
