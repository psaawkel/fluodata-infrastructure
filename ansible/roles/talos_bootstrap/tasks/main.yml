---
# =============================================================================
# Role: talos_bootstrap — Generate secrets, configs, apply, bootstrap, kubeconfig
#
# Platform-agnostic. Works for both Proxmox and VPS.
#
# Key variables:
#   - env_dir:              Local env folder — all final files end up here
#   - talos_work_dir:       Where talosctl runs. For VPS = env_dir. For Proxmox = remote tmp dir.
#   - talosctl_delegate_to: undefined = run on inventory host (Proxmox), "localhost" = run locally (VPS)
#
# Proxmox flow: talosctl runs on Proxmox host (remote), results fetched to env_dir
# VPS flow:     talosctl runs locally, talos_work_dir = env_dir, no fetching needed
# =============================================================================

# --- Determine remote work dir for Proxmox ---
# Per-environment dir prevents secret/config leakage between environments
- name: Set remote work directory (Proxmox)
  ansible.builtin.set_fact:
    _talos_remote_dir: "/tmp/talos-deploy/{{ env_dir | basename }}"
  when: talosctl_delegate_to is not defined

- name: Set remote work directory (VPS / localhost)
  ansible.builtin.set_fact:
    _talos_remote_dir: "{{ env_dir }}"
  when: talosctl_delegate_to is defined

# --- Create directories ---
- name: Create remote work directory
  ansible.builtin.file:
    path: "{{ _talos_remote_dir }}"
    state: directory
    mode: "0700"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Create local env directory
  ansible.builtin.file:
    path: "{{ env_dir }}"
    state: directory
    mode: "0700"
  delegate_to: localhost
  become: false
  when: talosctl_delegate_to is not defined

# =============================================================================
# Secrets generation (idempotent — generated once, reused across deploys)
# =============================================================================
- name: Check if secrets exist in env dir
  ansible.builtin.stat:
    path: "{{ env_dir }}/secrets.yaml"
  register: secrets_local_stat
  delegate_to: localhost
  become: false

- name: Check if secrets exist in remote work dir
  ansible.builtin.stat:
    path: "{{ _talos_remote_dir }}/secrets.yaml"
  register: secrets_remote_stat
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false
  when: talosctl_delegate_to is not defined

- name: Generate Talos secrets
  ansible.builtin.command:
    cmd: >-
      talosctl gen secrets
        --output-file {{ _talos_remote_dir }}/secrets.yaml
        --talos-version {{ talos_version }}
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false
  when: >-
    not secrets_local_stat.stat.exists
    and (talosctl_delegate_to is defined or not secrets_remote_stat.stat.exists)

- name: Copy secrets to remote work dir (from env dir)
  ansible.builtin.copy:
    src: "{{ env_dir }}/secrets.yaml"
    dest: "{{ _talos_remote_dir }}/secrets.yaml"
    mode: "0600"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false
  when:
    - secrets_local_stat.stat.exists
    - talosctl_delegate_to is not defined

- name: Fetch secrets to env dir (Proxmox — newly generated)
  ansible.builtin.fetch:
    src: "{{ _talos_remote_dir }}/secrets.yaml"
    dest: "{{ env_dir }}/secrets.yaml"
    flat: true
  when:
    - not secrets_local_stat.stat.exists
    - talosctl_delegate_to is not defined

# =============================================================================
# Generate config patches from templates
# =============================================================================
- name: Generate control plane common patch
  ansible.builtin.template:
    src: patch-cp-common.yaml.j2
    dest: "{{ _talos_remote_dir }}/patch-cp-common.yaml"
    mode: "0600"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate worker common patch
  ansible.builtin.template:
    src: patch-worker-common.yaml.j2
    dest: "{{ _talos_remote_dir }}/patch-worker-common.yaml"
    mode: "0600"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate per-node patches
  ansible.builtin.template:
    src: patch-node.yaml.j2
    dest: "{{ _talos_remote_dir }}/patch-{{ item.name }}.yaml"
    mode: "0600"
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# =============================================================================
# Generate Talos configs from secrets + patches
# =============================================================================
- name: Generate control plane config
  ansible.builtin.command:
    cmd: >-
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
        --with-secrets {{ _talos_remote_dir }}/secrets.yaml
        --config-patch @{{ _talos_remote_dir }}/patch-cp-common.yaml
        --output {{ _talos_remote_dir }}/controlplane.yaml
        --output-types controlplane
        --talos-version {{ talos_version }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate worker config
  ansible.builtin.command:
    cmd: >-
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
        --with-secrets {{ _talos_remote_dir }}/secrets.yaml
        --config-patch @{{ _talos_remote_dir }}/patch-worker-common.yaml
        --output {{ _talos_remote_dir }}/worker.yaml
        --output-types worker
        --talos-version {{ talos_version }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false
  when: (worker_nodes | default([])) | length > 0

- name: Generate talosconfig
  ansible.builtin.command:
    cmd: >-
      talosctl gen config {{ cluster_name }} {{ cluster_endpoint }}
        --with-secrets {{ _talos_remote_dir }}/secrets.yaml
        --output {{ _talos_remote_dir }}/talosconfig
        --output-types talosconfig
        --talos-version {{ talos_version }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# Fix empty endpoints in generated talosconfig
- name: Set talosconfig endpoint
  ansible.builtin.command:
    cmd: >-
      talosctl --talosconfig {{ _talos_remote_dir }}/talosconfig
        config endpoint {{ cluster_vip | default(controlplane_nodes[0].ip) }}
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Set talosconfig default nodes
  ansible.builtin.command:
    cmd: >-
      talosctl --talosconfig {{ _talos_remote_dir }}/talosconfig
        config nodes {{ controlplane_nodes | map(attribute='ip') | join(' ') }}
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# =============================================================================
# Wait for Talos maintenance mode, apply configs
# =============================================================================
- name: Wait for Talos API on all nodes (port 50000)
  ansible.builtin.wait_for:
    host: "{{ item.ip }}"
    port: 50000
    timeout: 300
    delay: 10
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Apply config to control plane nodes
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --insecure
        --nodes {{ item.ip }}
        --endpoints {{ item.ip }}
        --config-patch @{{ _talos_remote_dir }}/patch-{{ item.name }}.yaml
        --file {{ _talos_remote_dir }}/controlplane.yaml
  loop: "{{ controlplane_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Apply config to worker nodes
  ansible.builtin.command:
    cmd: >-
      talosctl apply-config
        --insecure
        --nodes {{ item.ip }}
        --endpoints {{ item.ip }}
        --config-patch @{{ _talos_remote_dir }}/patch-{{ item.name }}.yaml
        --file {{ _talos_remote_dir }}/worker.yaml
  loop: "{{ worker_nodes | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false
  when: (worker_nodes | default([])) | length > 0

# =============================================================================
# Wait for reboot, bootstrap, kubeconfig
# =============================================================================
- name: Wait for nodes to reboot and Talos API to come back
  ansible.builtin.wait_for:
    host: "{{ item.ip }}"
    port: 50000
    timeout: 300
    delay: 30
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Bootstrap etcd on first control plane
  ansible.builtin.command:
    cmd: >-
      talosctl bootstrap
        --talosconfig {{ _talos_remote_dir }}/talosconfig
        --nodes {{ controlplane_nodes[0].ip }}
        --endpoints {{ controlplane_nodes[0].ip }}
  register: bootstrap_result
  failed_when:
    - bootstrap_result.rc != 0
    - "'AlreadyExists' not in bootstrap_result.stderr"
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Wait for Kubernetes API (port 6443)
  ansible.builtin.wait_for:
    host: "{{ cluster_vip | default(controlplane_nodes[0].ip) }}"
    port: 6443
    timeout: 300
    delay: 15
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

- name: Generate kubeconfig
  ansible.builtin.command:
    cmd: >-
      talosctl kubeconfig {{ _talos_remote_dir }}/kubeconfig
        --talosconfig {{ _talos_remote_dir }}/talosconfig
        --nodes {{ controlplane_nodes[0].ip }}
        --endpoints {{ cluster_vip | default(controlplane_nodes[0].ip) }}
        --force
  delegate_to: "{{ talosctl_delegate_to | default(omit) }}"
  become: false

# =============================================================================
# Fetch all generated files to env dir (Proxmox only — VPS already local)
# =============================================================================
- name: Fetch generated files to env dir
  ansible.builtin.fetch:
    src: "{{ _talos_remote_dir }}/{{ item }}"
    dest: "{{ env_dir }}/{{ item }}"
    flat: true
  loop:
    - talosconfig
    - kubeconfig
    - controlplane.yaml
    - patch-cp-common.yaml
  when: talosctl_delegate_to is not defined

- name: Fetch worker config to env dir
  ansible.builtin.fetch:
    src: "{{ _talos_remote_dir }}/worker.yaml"
    dest: "{{ env_dir }}/worker.yaml"
    flat: true
  when:
    - talosctl_delegate_to is not defined
    - (worker_nodes | default([])) | length > 0

- name: Fetch per-node patches to env dir
  ansible.builtin.fetch:
    src: "{{ _talos_remote_dir }}/patch-{{ item.name }}.yaml"
    dest: "{{ env_dir }}/patch-{{ item.name }}.yaml"
    flat: true
  loop: "{{ all_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  when: talosctl_delegate_to is not defined

- name: Fetch worker common patch to env dir
  ansible.builtin.fetch:
    src: "{{ _talos_remote_dir }}/patch-worker-common.yaml"
    dest: "{{ env_dir }}/patch-worker-common.yaml"
    flat: true
  when:
    - talosctl_delegate_to is not defined
    - (worker_nodes | default([])) | length > 0
